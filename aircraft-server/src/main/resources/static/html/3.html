<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠœæ¹–èµ·é£ - æœºç¥¨é¢„è®¢ç³»ç»Ÿ</title>
    <style>
        /* ==================== ä¿ç•™ä½ åŸæœ‰çš„æ‰€æœ‰æ ·å¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px 40px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* å¯¼èˆªæ ‡ç­¾é¡µ */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .nav-tab {
            padding: 10px 25px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
        }

        .content {
            padding: 40px;
        }

        /* é¡µé¢åˆ‡æ¢ */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .search-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .search-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-search {
            grid-column: 1 / -1;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-search:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .sort-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .sort-buttons button {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .sort-buttons button:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .sort-buttons button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .results-section {
            margin-top: 30px;
        }

        .flight-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .flight-card:hover {
            border-color: #667eea;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
            transform: translateY(-5px);
        }

        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .flight-number {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .airline-name {
            font-size: 1em;
            color: #666;
            margin-left: 15px;
        }

        .flight-price {
            font-size: 2em;
            font-weight: 700;
            color: #e74c3c;
        }

        .flight-route {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 25px 0;
        }

        .airport-info {
            flex: 1;
            text-align: center;
        }

        .airport-time {
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .airport-code {
            font-size: 1.3em;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        .airport-name {
            font-size: 0.9em;
            color: #999;
        }

        .flight-path {
            flex: 0 0 150px;
            text-align: center;
            color: #999;
        }

        .path-duration {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .path-line {
            height: 2px;
            background: #e0e0e0;
            position: relative;
            margin: 10px 0;
        }

        .path-line::after {
            content: 'â†’';
            position: absolute;
            right: -10px;
            top: -12px;
            font-size: 1.5em;
            color: #667eea;
        }

        .flight-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }

        .flight-details {
            display: flex;
            gap: 30px;
            color: #666;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-book {
            padding: 12px 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-book:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        /* è®¢å•å¡ç‰‡æ ·å¼ */
        .order-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .order-card:hover {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .order-id {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
        }

        .order-status {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .status-hold {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .order-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 0.85em;
            color: #666;
        }

        .info-value {
            font-size: 1em;
            color: #333;
            font-weight: 600;
        }

        .order-passengers {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-left: 4px solid #667eea;
        }

        .btn-cancel-order {
            padding: 10px 30px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-cancel-order:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-cancel-order:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-text {
            font-size: 1.3em;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
        }

        .modal-header h2 {
            font-size: 1.8em;
        }

        .modal-body {
            padding: 30px;
        }

        .booking-section {
            margin-bottom: 30px;
        }

        .booking-section h3 {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .seat-map {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .seat-row {
            display: flex;
            gap: 10px;
        }

        .seat {
            width: 45px;
            height: 45px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .seat.available {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .seat.available:hover {
            background: #4caf50;
            color: white;
            transform: scale(1.1);
        }

        .seat.selected {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .seat.occupied {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
            cursor: not-allowed;
        }

        .seat-aisle {
            width: 30px;
        }

        .passenger-forms {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .passenger-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .passenger-form h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .order-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .summary-row:last-child {
            border-bottom: none;
            font-size: 1.2em;
            font-weight: 700;
            color: #e74c3c;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 2px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .btn-cancel {
            padding: 12px 30px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-submit {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .search-form {
                grid-template-columns: 1fr;
            }

            .flight-route {
                flex-direction: column;
                gap: 20px;
            }

            .flight-path {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <div>
            <h1>âœˆï¸ èŠœæ¹–èµ·é£</h1>
            <p>æœºç¥¨é¢„è®¢ç³»ç»Ÿ - ç˜¦å®¢æˆ·ç«¯ç‰ˆæœ¬</p>
        </div>
        <!-- å¯¼èˆªæ ‡ç­¾é¡µ -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchPage('search')">æŸ¥è¯¢èˆªç­</button>
            <button class="nav-tab" onclick="switchPage('orders')">æˆ‘çš„è®¢å•</button>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div class="content">
        <!-- ==================== èˆªç­æŸ¥è¯¢é¡µé¢ ==================== -->
        <div id="searchPage" class="page active">
            <!-- æœç´¢åŒºåŸŸ -->
            <div class="search-section">
                <div class="search-title">æŸ¥è¯¢èˆªç­</div>
                <form id="searchForm" class="search-form">
                    <div class="form-group">
                        <label>å‡ºå‘æœºåœº</label>
                        <select id="departAirport" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>åˆ°è¾¾æœºåœº</label>
                        <select id="arrivalAirport" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å‡ºè¡Œæ—¥æœŸ</label>
                        <input type="date" id="flightDate" required>
                    </div>

                    <div class="form-group">
                        <label>ä¹˜å®¢äººæ•°</label>
                        <input type="number" id="passengerCount" min="1" max="9" value="1" required>
                    </div>

                    <button type="submit" class="btn-search" id="searchButton">
                        æœç´¢èˆªç­
                    </button>
                </form>
            </div>

            <!-- æ’åºæŒ‰é’® -->
            <div id="sortButtons" class="sort-buttons" style="display: none;">
                <button type="button" class="sort-btn active" data-sort="">é»˜è®¤æ’åº</button>
                <button type="button" class="sort-btn" data-sort="PRICE">ä»·æ ¼æœ€ä½</button>
                <button type="button" class="sort-btn" data-sort="TIME">æ—¶é—´æœ€çŸ­</button>
            </div>

            <!-- ç»“æœåŒºåŸŸ -->
            <div id="flightResults" class="results-section"></div>
        </div>

        <!-- ==================== æˆ‘çš„è®¢å•é¡µé¢ ==================== -->
        <div id="ordersPage" class="page">
            <!-- æŸ¥è¯¢è¡¨å• -->
            <div class="search-section">
                <div class="search-title">æŸ¥è¯¢è®¢å•</div>
                <form id="orderQueryForm" class="search-form">
                    <div class="form-group">
                        <label>æ‰‹æœºå·</label>
                        <input type="tel" id="queryPhone" value="13800138000" required pattern="^1[3-9]\d{9}$">
                    </div>

                    <button type="submit" class="btn-search" id="queryOrderButton">
                        æŸ¥è¯¢è®¢å•
                    </button>
                </form>
            </div>

            <!-- è®¢å•åˆ—è¡¨ -->
            <div id="orderResults" class="results-section"></div>
        </div>
    </div>
</div>

<!-- é¢„è®¢æ¨¡æ€æ¡†ï¼ˆä¿æŒåŸæ ·ï¼‰ -->
<div id="bookingModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ç¡®è®¤è®¢å•</h2>
        </div>
        <div class="modal-body">
            <div class="booking-section">
                <h3>èˆªç­ä¿¡æ¯</h3>
                <div id="selectedFlightInfo"></div>
            </div>
            <div class="booking-section">
                <h3>é€‰æ‹©åº§ä½ (<span id="selectedCount">0</span> / <span id="totalCount">0</span>)</h3>
                <div id="seatMap" class="seat-map"></div>
            </div>
            <div class="booking-section">
                <h3>ä¹˜å®¢ä¿¡æ¯</h3>
                <div id="passengerForms" class="passenger-forms"></div>
            </div>
            <div class="booking-section">
                <h3>è®¢å•æ±‡æ€»</h3>
                <div class="order-summary" id="orderSummary"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeBookingModal()">å–æ¶ˆ</button>
            <button class="btn-submit" id="submitBooking">ç¡®è®¤é¢„è®¢</button>
        </div>
    </div>
</div>

<!-- å–æ¶ˆè®¢å•æ¨¡æ€æ¡† -->
<div id="cancelModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>å–æ¶ˆè®¢å•</h2>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>å–æ¶ˆåŸå› ï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="cancelReason" rows="4" placeholder="è¯·è¾“å…¥å–æ¶ˆåŸå› "></textarea>
            </div>
            <p style="color: #dc3545; margin-top: 15px;">âš ï¸ å–æ¶ˆåè®¢å•å°†æ— æ³•æ¢å¤</p>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeCancelModal()">å–æ¶ˆ</button>
            <button class="btn-submit" style="background: #dc3545;" id="confirmCancelBtn">ç¡®è®¤å–æ¶ˆ</button>
        </div>
    </div>
</div>
<script>
    // ==================== é…ç½®å’Œæ•°æ® ====================

    const API_BASE_URL = 'http://localhost:8080/api';

    // æœºåœºæ•°æ®
    const AIRPORTS = [
        { code: 'PEK', name: 'åŒ—äº¬é¦–éƒ½å›½é™…æœºåœº', city: 'åŒ—äº¬' },
        { code: 'PVG', name: 'ä¸Šæµ·æµ¦ä¸œå›½é™…æœºåœº', city: 'ä¸Šæµ·' },
        { code: 'SHA', name: 'ä¸Šæµ·è™¹æ¡¥å›½é™…æœºåœº', city: 'ä¸Šæµ·' },
        { code: 'CAN', name: 'å¹¿å·ç™½äº‘å›½é™…æœºåœº', city: 'å¹¿å·' },
        { code: 'SZX', name: 'æ·±åœ³å®å®‰å›½é™…æœºåœº', city: 'æ·±åœ³' },
        { code: 'CTU', name: 'æˆéƒ½åŒæµå›½é™…æœºåœº', city: 'æˆéƒ½' },
        { code: 'HGH', name: 'æ­å·è§å±±å›½é™…æœºåœº', city: 'æ­å·' },
        { code: 'WUH', name: 'æ­¦æ±‰å¤©æ²³å›½é™…æœºåœº', city: 'æ­¦æ±‰' },
        { code: 'XIY', name: 'è¥¿å®‰å’¸é˜³å›½é™…æœºåœº', city: 'è¥¿å®‰' },
        { code: 'CKG', name: 'é‡åº†æ±ŸåŒ—å›½é™…æœºåœº', city: 'é‡åº†' },
        { code: 'KMG', name: 'æ˜†æ˜é•¿æ°´å›½é™…æœºåœº', city: 'æ˜†æ˜' },
        { code: 'NKG', name: 'å—äº¬ç¦„å£å›½é™…æœºåœº', city: 'å—äº¬' }
    ];

    // å…¨å±€å˜é‡
    let currentSearchParams = null;
    let currentFlights = [];
    let selectedFlight = null;
    let selectedSeats = [];
    let seatMapData = null;
    let currentOrders = [];
    let cancellingBookingId = null;

    // ==================== å·¥å…·å‡½æ•° ====================

    function getCityName(code) {
        const airport = AIRPORTS.find(a => a.code === code);
        return airport ? airport.city : code;
    }

    function getAirportName(code) {
        const airport = AIRPORTS.find(a => a.code === code);
        return airport ? airport.name : code;
    }

    function formatTime(datetime) {
        if (!datetime) return '';
        const date = new Date(datetime);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    function formatDateTime(datetime) {
        if (!datetime) return '';
        const date = new Date(datetime);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    function formatDuration(minutes) {
        if (!minutes) return '';
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        if (hours === 0) return `${mins}åˆ†é’Ÿ`;
        if (mins === 0) return `${hours}å°æ—¶`;
        return `${hours}å°æ—¶${mins}åˆ†`;
    }

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function showMessage(message, type = 'info') {
        console.log(`[${type.toUpperCase()}] ${message}`);
        alert(message);
    }

    function setButtonLoading(button, loading) {
        if (loading) {
            button.disabled = true;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = '<span class="loading-spinner"></span>åŠ è½½ä¸­...';
        } else {
            button.disabled = false;
            button.innerHTML = button.dataset.originalText || 'æœç´¢';
        }
    }

    function getStatusText(status) {
        const statusMap = {
            'HOLD': 'å¾…æ”¯ä»˜',
            'CONFIRMED': 'å·²ç¡®è®¤',
            'CANCELLED': 'å·²å–æ¶ˆ',
            'COMPLETED': 'å·²å®Œæˆ'
        };
        return statusMap[status] || status;
    }

    function getStatusClass(status) {
        const classMap = {
            'HOLD': 'status-hold',
            'CONFIRMED': 'status-confirmed',
            'CANCELLED': 'status-cancelled',
            'COMPLETED': 'status-completed'
        };
        return classMap[status] || 'status-hold';
    }

    // ==================== API è¯·æ±‚ ====================

    async function apiRequest(url, options = {}) {
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        };

        const finalOptions = { ...defaultOptions, ...options };

        try {
            console.log('è¯·æ±‚:', API_BASE_URL + url, finalOptions);

            const response = await fetch(API_BASE_URL + url, finalOptions);

            console.log('å“åº”çŠ¶æ€:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
            }

            const data = await response.json();
            console.log('å“åº”æ•°æ®:', data);

            return data;
        } catch (error) {
            console.error('API è¯·æ±‚å¤±è´¥:', error);
            throw error;
        }
    }

    async function searchFlights(params) {
        return await apiRequest('/flights/search', {
            method: 'POST',
            body: JSON.stringify(params)
        });
    }

    async function getSeatMap(instanceId) {
        return await apiRequest(`/bookings/seat-map/${instanceId}`);
    }

    async function createBooking(bookingData) {
        return await apiRequest('/bookings', {
            method: 'POST',
            body: JSON.stringify(bookingData)
        });
    }

    async function queryOrders(phone) {
        return await apiRequest(`/bookings/my-bookings?phone=${encodeURIComponent(phone)}`);
    }

    async function cancelOrder(bookingId, reason) {
        return await apiRequest('/bookings/cancel', {
            method: 'POST',
            body: JSON.stringify({
                bookingId: bookingId,
                cancelReason: reason || 'ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ'
            })
        });
    }

    // ==================== é¡µé¢åˆ‡æ¢ ====================

    function switchPage(pageName) {
        console.log('åˆ‡æ¢é¡µé¢:', pageName);

        // éšè—æ‰€æœ‰é¡µé¢
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });

        // æ˜¾ç¤ºç›®æ ‡é¡µé¢
        const targetPage = document.getElementById(pageName + 'Page');
        if (targetPage) {
            targetPage.classList.add('active');
        }

        // æ›´æ–°å¯¼èˆªæ ‡ç­¾æ ·å¼
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');

        // å¦‚æœåˆ‡æ¢åˆ°è®¢å•é¡µé¢ï¼Œè‡ªåŠ¨åŠ è½½è®¢å•
        if (pageName === 'orders') {
            const phone = document.getElementById('queryPhone').value;
            if (phone) {
                loadOrders(phone);
            }
        }
    }

    // ==================== é¡µé¢åˆå§‹åŒ– ====================

    function initPage() {
        console.log('åˆå§‹åŒ–é¡µé¢...');

        populateAirportSelectors();
        setDefaultDate();
        bindEvents();

        console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
    }

    function populateAirportSelectors() {
        const departSelect = document.getElementById('departAirport');
        const arrivalSelect = document.getElementById('arrivalAirport');

        if (!departSelect || !arrivalSelect) {
            console.error('æœªæ‰¾åˆ°æœºåœºé€‰æ‹©å™¨');
            return;
        }

        departSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
        arrivalSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';

        AIRPORTS.forEach(airport => {
            const option1 = document.createElement('option');
            option1.value = airport.code;
            option1.textContent = `${airport.city} - ${airport.name}`;
            departSelect.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = airport.code;
            option2.textContent = `${airport.city} - ${airport.name}`;
            arrivalSelect.appendChild(option2);
        });

        console.log('æœºåœºé€‰æ‹©å™¨å¡«å……å®Œæˆ');
    }

    function setDefaultDate() {
        const dateInput = document.getElementById('flightDate');
        if (!dateInput) return;

        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);

        const year = tomorrow.getFullYear();
        const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
        const day = String(tomorrow.getDate()).padStart(2, '0');

        dateInput.value = `${year}-${month}-${day}`;
        dateInput.min = `${year}-${month}-${day}`;
    }

    function bindEvents() {
        // æœç´¢è¡¨å•
        const searchForm = document.getElementById('searchForm');
        if (searchForm) {
            searchForm.addEventListener('submit', handleSearch);
        }

        // è®¢å•æŸ¥è¯¢è¡¨å•
        const orderQueryForm = document.getElementById('orderQueryForm');
        if (orderQueryForm) {
            orderQueryForm.addEventListener('submit', handleQueryOrders);
        }

        // æ’åºæŒ‰é’®
        const sortButtons = document.querySelectorAll('.sort-btn');
        sortButtons.forEach(btn => {
            btn.addEventListener('click', () => handleSort(btn));
        });

        // æäº¤è®¢å•æŒ‰é’®
        const submitBtn = document.getElementById('submitBooking');
        if (submitBtn) {
            submitBtn.addEventListener('click', handleSubmitBooking);
        }

        // ç¡®è®¤å–æ¶ˆè®¢å•æŒ‰é’®
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        if (confirmCancelBtn) {
            confirmCancelBtn.addEventListener('click', handleConfirmCancel);
        }

        console.log('äº‹ä»¶ç»‘å®šå®Œæˆ');
    }

    // ==================== èˆªç­æœç´¢ï¼ˆä¿æŒåŸæ ·ï¼‰====================

    async function handleSearch(event) {
        event.preventDefault();

        console.log('å¼€å§‹æœç´¢èˆªç­');

        const submitBtn = document.getElementById('searchButton');

        const departAirport = document.getElementById('departAirport').value;
        const arrivalAirport = document.getElementById('arrivalAirport').value;
        const flightDate = document.getElementById('flightDate').value;
        const passengerCount = parseInt(document.getElementById('passengerCount').value);

        if (!departAirport || !arrivalAirport) {
            showMessage('è¯·é€‰æ‹©å‡ºå‘å’Œåˆ°è¾¾æœºåœº', 'warning');
            return;
        }

        if (departAirport === arrivalAirport) {
            showMessage('å‡ºå‘æœºåœºå’Œåˆ°è¾¾æœºåœºä¸èƒ½ç›¸åŒ', 'warning');
            return;
        }

        if (!flightDate) {
            showMessage('è¯·é€‰æ‹©å‡ºè¡Œæ—¥æœŸ', 'warning');
            return;
        }

        if (!passengerCount || passengerCount < 1 || passengerCount > 9) {
            showMessage('ä¹˜å®¢äººæ•°å¿…é¡»åœ¨ 1-9 ä¹‹é—´', 'warning');
            return;
        }

        const params = {
            departCity: departAirport,
            arrivalCity: arrivalAirport,
            flightDate: flightDate,
            passengerCount: passengerCount,
            sortType: null
        };

        console.log('æŸ¥è¯¢å‚æ•°:', params);

        currentSearchParams = params;

        setButtonLoading(submitBtn, true);

        try {
            const flights = await searchFlights(params);

            currentFlights = flights;
            displayFlights(flights);

            const sortButtonsContainer = document.getElementById('sortButtons');
            if (sortButtonsContainer) {
                sortButtonsContainer.style.display = flights.length > 0 ? 'flex' : 'none';
            }

            if (flights.length === 0) {
                showMessage('æœªæŸ¥è¯¢åˆ°ç¬¦åˆæ¡ä»¶çš„èˆªç­', 'info');
            } else {
                showMessage(`æŸ¥è¯¢åˆ° ${flights.length} ä¸ªèˆªç­`, 'success');
            }

        } catch (error) {
            console.error('æŸ¥è¯¢å¤±è´¥:', error);
            showMessage('æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');

            document.getElementById('flightResults').innerHTML = '';

        } finally {
            setButtonLoading(submitBtn, false);
        }
    }

    async function handleSort(button) {
        const sortType = button.dataset.sort;
        console.log('åˆ‡æ¢æ’åº:', sortType || 'é»˜è®¤');

        const allButtons = document.querySelectorAll('.sort-btn');
        allButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        if (currentSearchParams) {
            currentSearchParams.sortType = sortType || null;

            try {
                const flights = await searchFlights(currentSearchParams);
                currentFlights = flights;
                displayFlights(flights);

                const sortName = sortType === 'PRICE' ? 'ä»·æ ¼' :
                    sortType === 'TIME' ? 'æ—¶é—´' : 'é»˜è®¤';
                showMessage(`å·²æŒ‰${sortName}æ’åº`, 'success');
            } catch (error) {
                showMessage('æ’åºå¤±è´¥: ' + error.message, 'error');
            }
        }
    }

    function displayFlights(flights) {
        const container = document.getElementById('flightResults');

        if (!container) {
            console.error('æœªæ‰¾åˆ°ç»“æœå®¹å™¨');
            return;
        }

        container.innerHTML = '';

        if (flights.length === 0) {
            container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âœˆï¸</div>
                        <div class="empty-text">æœªæŸ¥è¯¢åˆ°ç¬¦åˆæ¡ä»¶çš„èˆªç­</div>
                    </div>
                `;
            return;
        }

        flights.forEach(flight => {
            const card = createFlightCard(flight);
            container.appendChild(card);
        });

        console.log('æ˜¾ç¤º', flights.length, 'ä¸ªèˆªç­');
    }

    function createFlightCard(flight) {
        const card = document.createElement('div');
        card.className = 'flight-card';

        const departTime = formatTime(flight.departDatetime);
        const arrivalTime = formatTime(flight.arrivalDatetime);
        const duration = formatDuration(flight.flightDurationMin);

        card.innerHTML = `
                <div class="flight-header">
                    <div>
                        <span class="flight-number">${flight.flightNumber}</span>
                        <span class="airline-name">${flight.airlineName}</span>
                    </div>
                    <div class="flight-price">Â¥${flight.price}</div>
                </div>

                <div class="flight-route">
                    <div class="airport-info">
                        <div class="airport-time">${departTime}</div>
                        <div class="airport-code">${flight.departAirport}</div>
                        <div class="airport-name">${getCityName(flight.departAirport)}</div>
                    </div>

                    <div class="flight-path">
                        <div class="path-duration">${duration}</div>
                        <div class="path-line"></div>
                        <div>ç›´é£</div>
                    </div>

                    <div class="airport-info">
                        <div class="airport-time">${arrivalTime}</div>
                        <div class="airport-code">${flight.arrivalAirport}</div>
                        <div class="airport-name">${getCityName(flight.arrivalAirport)}</div>
                    </div>
                </div>

                <div class="flight-footer">
                    <div class="flight-details">
                        <div class="detail-item">
                            <span>æœºå‹: ${flight.aircraftName || flight.aircraftCode}</span>
                        </div>
                        <div class="detail-item">
                            <span>å‰©ä½™: ${flight.availableSeats} åº§</span>
                        </div>
                    </div>
                    <button class="btn-book" onclick="openBookingModal('${flight.instanceId}')">
                        ç«‹å³é¢„è®¢
                    </button>
                </div>
            `;

        return card;
    }

    // ==================== è®¢å•æŸ¥è¯¢å’Œç®¡ç† ====================

    async function handleQueryOrders(event) {
        event.preventDefault();

        const phone = document.getElementById('queryPhone').value.trim();

        if (!phone) {
            showMessage('è¯·è¾“å…¥æ‰‹æœºå·', 'warning');
            return;
        }

        await loadOrders(phone);
    }

    async function loadOrders(phone) {
        console.log('æŸ¥è¯¢è®¢å•:', phone);

        const submitBtn = document.getElementById('queryOrderButton');
        setButtonLoading(submitBtn, true);

        try {
            const orders = await queryOrders(phone);

            currentOrders = orders;
            displayOrders(orders);

            if (orders.length === 0) {
                showMessage('æœªæŸ¥è¯¢åˆ°è®¢å•', 'info');
            } else {
                showMessage(`æŸ¥è¯¢åˆ° ${orders.length} ä¸ªè®¢å•`, 'success');
            }

        } catch (error) {
            console.error('æŸ¥è¯¢è®¢å•å¤±è´¥:', error);
            showMessage('æŸ¥è¯¢è®¢å•å¤±è´¥: ' + error.message, 'error');

            document.getElementById('orderResults').innerHTML = '';

        } finally {
            setButtonLoading(submitBtn, false);
        }
    }

    function displayOrders(orders) {
        const container = document.getElementById('orderResults');

        if (!container) {
            console.error('æœªæ‰¾åˆ°è®¢å•ç»“æœå®¹å™¨');
            return;
        }

        container.innerHTML = '';

        if (orders.length === 0) {
            container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“‹</div>
                        <div class="empty-text">æœªæŸ¥è¯¢åˆ°è®¢å•è®°å½•</div>
                    </div>
                `;
            return;
        }

        orders.forEach(order => {
            const card = createOrderCard(order);
            container.appendChild(card);
        });

        console.log('æ˜¾ç¤º', orders.length, 'ä¸ªè®¢å•');
    }

    function createOrderCard(order) {
        const card = document.createElement('div');
        card.className = 'order-card';

        const statusText = getStatusText(order.status);
        const statusClass = getStatusClass(order.status);

        card.innerHTML = `
                <div class="order-header">
                    <div class="order-id">è®¢å•å·: ${order.bookingId}</div>
                    <div class="order-status ${statusClass}">${statusText}</div>
                </div>

                <div class="order-info">
                    <div class="info-item">
                        <div class="info-label">èˆªç­å·</div>
                        <div class="info-value">${order.flightNumber}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">èˆªç©ºå…¬å¸</div>
                        <div class="info-value">${order.airlineName}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å‡ºå‘</div>
                        <div class="info-value">${order.departAirportName || order.departAirport}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">åˆ°è¾¾</div>
                        <div class="info-value">${order.arrivalAirportName || order.arrivalAirport}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">èµ·é£æ—¶é—´</div>
                        <div class="info-value">${formatDateTime(order.departDatetime)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">é¢„è®¢æ—¶é—´</div>
                        <div class="info-value">${formatDateTime(order.bookingTime)}</div>
                    </div>
                </div>

                <div class="order-passengers">
                    <strong>ä¹˜å®¢:</strong> ${order.passengerNames ? order.passengerNames.join('ã€') : 'æ— '}
                </div>

                <div class="flight-footer">
                    <div class="flight-price">Â¥${order.totalPrice}</div>
                    ${order.cancellable ?
            `<button class="btn-cancel-order" onclick="openCancelModal('${order.bookingId}')">å–æ¶ˆè®¢å•</button>` :
            `<button class="btn-cancel-order" disabled>${order.status === 'CANCELLED' ? 'å·²å–æ¶ˆ' : 'æ— æ³•å–æ¶ˆ'}</button>`
        }
                </div>
            `;

        return card;
    }

    function openCancelModal(bookingId) {
        console.log('æ‰“å¼€å–æ¶ˆè®¢å•æ¨¡æ€æ¡†:', bookingId);

        cancellingBookingId = bookingId;

        document.getElementById('cancelReason').value = '';

        const modal = document.getElementById('cancelModal');
        modal.classList.add('active');
    }

    function closeCancelModal() {
        cancellingBookingId = null;

        const modal = document.getElementById('cancelModal');
        modal.classList.remove('active');
    }

    async function handleConfirmCancel() {
        if (!cancellingBookingId) {
            showMessage('è®¢å•å·æ— æ•ˆ', 'error');
            return;
        }

        const reason = document.getElementById('cancelReason').value.trim();

        console.log('å–æ¶ˆè®¢å•:', cancellingBookingId, 'åŸå› :', reason || 'æ— ');

        const confirmBtn = document.getElementById('confirmCancelBtn');
        setButtonLoading(confirmBtn, true);

        try {
            const response = await cancelOrder(cancellingBookingId, reason);

            console.log('å–æ¶ˆè®¢å•å“åº”:', response);

            if (response.status === 'SUCCESS') {
                showMessage('è®¢å•å–æ¶ˆæˆåŠŸ', 'success');

                closeCancelModal();

                // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
                const phone = document.getElementById('queryPhone').value;
                if (phone) {
                    setTimeout(() => {
                        loadOrders(phone);
                    }, 1000);
                }
            } else {
                showMessage('å–æ¶ˆå¤±è´¥: ' + response.message, 'error');
            }

        } catch (error) {
            console.error('å–æ¶ˆè®¢å•å¤±è´¥:', error);
            showMessage('å–æ¶ˆè®¢å•å¤±è´¥: ' + error.message, 'error');

        } finally {
            setButtonLoading(confirmBtn, false);
        }
    }

    // ==================== é¢„è®¢æµç¨‹ï¼ˆä¿æŒåŸæ ·ï¼‰====================

    async function openBookingModal(instanceId) {
        console.log('æ‰“å¼€é¢„è®¢æ¨¡æ€æ¡†:', instanceId);

        selectedFlight = currentFlights.find(f => f.instanceId === instanceId);

        if (!selectedFlight) {
            showMessage('æœªæ‰¾åˆ°èˆªç­ä¿¡æ¯', 'error');
            return;
        }

        selectedSeats = [];

        const modal = document.getElementById('bookingModal');
        modal.classList.add('active');

        displaySelectedFlightInfo();
        await loadSeatMap(instanceId);
        generatePassengerForms();
        updateOrderSummary();
    }

    function closeBookingModal() {
        const modal = document.getElementById('bookingModal');
        modal.classList.remove('active');

        selectedFlight = null;
        selectedSeats = [];
        seatMapData = null;
    }

    function displaySelectedFlightInfo() {
        const container = document.getElementById('selectedFlightInfo');

        if (!container || !selectedFlight) return;

        container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 15px; background: white; border-radius: 10px;">
                    <div><strong>èˆªç­å·:</strong> ${selectedFlight.flightNumber}</div>
                    <div><strong>èˆªå¸:</strong> ${selectedFlight.airlineName}</div>
                    <div><strong>å‡ºå‘:</strong> ${getCityName(selectedFlight.departAirport)} ${formatTime(selectedFlight.departDatetime)}</div>
                    <div><strong>åˆ°è¾¾:</strong> ${getCityName(selectedFlight.arrivalAirport)} ${formatTime(selectedFlight.arrivalDatetime)}</div>
                    <div><strong>ä»·æ ¼:</strong> <span style="color: #e74c3c; font-weight: bold;">Â¥${selectedFlight.price}</span></div>
                </div>
            `;
    }

    async function loadSeatMap(instanceId) {
        try {
            console.log('åŠ è½½åº§ä½å›¾:', instanceId);

            seatMapData = await getSeatMap(instanceId);

            renderSeatMap();

        } catch (error) {
            console.error('åŠ è½½åº§ä½å›¾å¤±è´¥:', error);
            showMessage('åŠ è½½åº§ä½å›¾å¤±è´¥: ' + error.message, 'error');
        }
    }

    function renderSeatMap() {
        const container = document.getElementById('seatMap');

        if (!container || !seatMapData || !seatMapData.seats) {
            console.error('åº§ä½æ•°æ®æ— æ•ˆ');
            return;
        }

        const passengerCount = currentSearchParams ? currentSearchParams.passengerCount : 1;
        document.getElementById('totalCount').textContent = passengerCount;
        document.getElementById('selectedCount').textContent = selectedSeats.length;

        const seats = seatMapData.seats;
        const rowCount = Math.max(...seats.map(s => s.rowNumber));

        const seatsByRow = {};
        seats.forEach(seat => {
            if (!seatsByRow[seat.rowNumber]) {
                seatsByRow[seat.rowNumber] = [];
            }
            seatsByRow[seat.rowNumber].push(seat);
        });

        container.innerHTML = '';

        for (let row = 1; row <= rowCount; row++) {
            const rowSeats = seatsByRow[row] || [];
            const rowDiv = document.createElement('div');
            rowDiv.className = 'seat-row';

            ['A', 'B', 'C'].forEach(letter => {
                const seat = rowSeats.find(s => s.seatLetter === letter);
                if (seat) {
                    rowDiv.appendChild(createSeatElement(seat));
                }
            });

            const aisle = document.createElement('div');
            aisle.className = 'seat-aisle';
            rowDiv.appendChild(aisle);

            ['D', 'E', 'F'].forEach(letter => {
                const seat = rowSeats.find(s => s.seatLetter === letter);
                if (seat) {
                    rowDiv.appendChild(createSeatElement(seat));
                }
            });

            container.appendChild(rowDiv);
        }
    }

    function createSeatElement(seat) {
        const seatDiv = document.createElement('div');
        seatDiv.className = 'seat';
        seatDiv.textContent = seat.seatNumber;

        const isSelected = selectedSeats.includes(seat.seatNumber);

        if (seat.status === 'AVAILABLE') {
            seatDiv.classList.add(isSelected ? 'selected' : 'available');
            seatDiv.onclick = () => toggleSeat(seat.seatNumber);
        } else {
            seatDiv.classList.add('occupied');
        }

        return seatDiv;
    }

    function toggleSeat(seatNumber) {
        const passengerCount = currentSearchParams ? currentSearchParams.passengerCount : 1;

        const index = selectedSeats.indexOf(seatNumber);

        if (index > -1) {
            selectedSeats.splice(index, 1);
        } else {
            if (selectedSeats.length >= passengerCount) {
                showMessage(`æœ€å¤šåªèƒ½é€‰æ‹© ${passengerCount} ä¸ªåº§ä½`, 'warning');
                return;
            }
            selectedSeats.push(seatNumber);
        }

        renderSeatMap();
        updateOrderSummary();
    }

    function generatePassengerForms() {
        const container = document.getElementById('passengerForms');

        if (!container) return;

        const passengerCount = currentSearchParams ? currentSearchParams.passengerCount : 1;

        container.innerHTML = '';

        for (let i = 0; i < passengerCount; i++) {
            const formDiv = document.createElement('div');
            formDiv.className = 'passenger-form';

            formDiv.innerHTML = `
                    <h4>ä¹˜å®¢ ${i + 1} ${i === 0 ? 'ï¼ˆè”ç³»äººï¼‰' : ''}</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å§“å *</label>
                            <input type="text" id="name_${i}" required>
                        </div>
                        <div class="form-group">
                            <label>è¯ä»¶ç±»å‹ *</label>
                            <select id="idType_${i}" required>
                                <option value="ID_CARD">èº«ä»½è¯</option>
                                <option value="PASSPORT">æŠ¤ç…§</option>
                                <option value="OTHER">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è¯ä»¶å· *</label>
                            <input type="text" id="idNumber_${i}" required>
                        </div>
                        <div class="form-group">
                            <label>æ‰‹æœºå· *</label>
                            <input type="tel" id="phone_${i}" required pattern="^1[3-9]\\d{9}$">
                        </div>
                        <div class="form-group">
                            <label>é‚®ç®±</label>
                            <input type="email" id="email_${i}">
                        </div>
                        <div class="form-group">
                            <label>ä¹˜å®¢ç±»å‹ *</label>
                            <select id="passengerType_${i}" required>
                                <option value="ADULT">æˆäºº</option>
                                <option value="CHILD">å„¿ç«¥</option>
                                <option value="INFANT">å©´å„¿</option>
                            </select>
                        </div>
                    </div>
                `;

            container.appendChild(formDiv);
        }
    }

    function updateOrderSummary() {
        const container = document.getElementById('orderSummary');

        if (!container || !selectedFlight) return;

        const passengerCount = currentSearchParams ? currentSearchParams.passengerCount : 1;
        const totalPrice = selectedFlight.price * passengerCount;

        container.innerHTML = `
                <div class="summary-row">
                    <span>èˆªç­:</span>
                    <span>${selectedFlight.flightNumber}</span>
                </div>
                <div class="summary-row">
                    <span>ä¹˜å®¢äººæ•°:</span>
                    <span>${passengerCount}</span>
                </div>
                <div class="summary-row">
                    <span>å•ä»·:</span>
                    <span>Â¥${selectedFlight.price}</span>
                </div>
                <div class="summary-row">
                    <span>å·²é€‰åº§ä½:</span>
                    <span>${selectedSeats.join(', ') || 'æœªé€‰æ‹©'}</span>
                </div>
                <div class="summary-row">
                    <span>æ€»ä»·:</span>
                    <span>Â¥${totalPrice}</span>
                </div>
            `;
    }

    async function handleSubmitBooking() {
        console.log('æäº¤è®¢å•');

        const passengerCount = currentSearchParams ? currentSearchParams.passengerCount : 1;

        if (selectedSeats.length !== passengerCount) {
            showMessage(`è¯·é€‰æ‹© ${passengerCount} ä¸ªåº§ä½ï¼ˆå½“å‰å·²é€‰ ${selectedSeats.length} ä¸ªï¼‰`, 'warning');
            return;
        }

        const passengers = [];
        for (let i = 0; i < passengerCount; i++) {
            const name = document.getElementById(`name_${i}`).value.trim();
            const idType = document.getElementById(`idType_${i}`).value;
            const idNumber = document.getElementById(`idNumber_${i}`).value.trim();
            const phone = document.getElementById(`phone_${i}`).value.trim();
            const email = document.getElementById(`email_${i}`).value.trim();
            const passengerType = document.getElementById(`passengerType_${i}`).value;

            if (!name || !idNumber || !phone) {
                showMessage(`è¯·å®Œæ•´å¡«å†™ä¹˜å®¢ ${i + 1} çš„ä¿¡æ¯`, 'warning');
                return;
            }

            passengers.push({
                passengerName: name,
                idType: idType,
                idNumber: idNumber,
                phone: phone,
                email: email || null,
                passengerType: passengerType,
                seatPreference: 'ANY'
            });
        }

        const bookingData = {
            instanceId: selectedFlight.instanceId,
            passengers: passengers,
            seatNumbers: selectedSeats,
            contactPassengerIndex: 0,
            clientToken: generateUUID(),
            remark: 'ç˜¦å®¢æˆ·ç«¯é¢„è®¢'
        };

        console.log('è®¢å•æ•°æ®:', bookingData);

        const submitBtn = document.getElementById('submitBooking');
        setButtonLoading(submitBtn, true);

        try {
            const response = await createBooking(bookingData);

            console.log('è®¢å•åˆ›å»ºæˆåŠŸ:', response);

            showMessage('è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•å·: ' + response.bookingId, 'success');

            closeBookingModal();

        } catch (error) {
            console.error('è®¢å•åˆ›å»ºå¤±è´¥:', error);
            showMessage('è®¢å•åˆ›å»ºå¤±è´¥: ' + error.message, 'error');

        } finally {
            setButtonLoading(submitBtn, false);
        }
    }

    // ==================== é¡µé¢åŠ è½½ ====================

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPage);
    } else {
        initPage();
    }

    console.log('è„šæœ¬åŠ è½½å®Œæˆ');
</script>
</body>
</html>