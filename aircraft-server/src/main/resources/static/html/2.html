<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>芜湖起飞 - 机票预订系统</title>
  <style>
    /* ==================== 保留你原有的所有样式 ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px 40px;
      color: white;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .content {
      padding: 40px;
    }

    .search-section {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
    }

    .search-title {
      font-size: 1.5em;
      color: #333;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .search-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-group input,
    .form-group select {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-search {
      grid-column: 1 / -1;
      padding: 15px 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-search:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-search:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .sort-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 10px;
    }

    .sort-buttons button {
      padding: 10px 20px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    .sort-buttons button:hover {
      border-color: #667eea;
      color: #667eea;
    }

    .sort-buttons button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
    }

    .results-section {
      margin-top: 30px;
    }

    .flight-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .flight-card:hover {
      border-color: #667eea;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
      transform: translateY(-5px);
    }

    .flight-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .flight-number {
      font-size: 1.5em;
      font-weight: 700;
      color: #667eea;
    }

    .airline-name {
      font-size: 1em;
      color: #666;
      margin-left: 15px;
    }

    .flight-price {
      font-size: 2em;
      font-weight: 700;
      color: #e74c3c;
    }

    .flight-route {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 25px 0;
    }

    .airport-info {
      flex: 1;
      text-align: center;
    }

    .airport-time {
      font-size: 1.8em;
      font-weight: 700;
      color: #333;
      margin-bottom: 5px;
    }

    .airport-code {
      font-size: 1.3em;
      font-weight: 600;
      color: #555;
      margin-bottom: 5px;
    }

    .airport-name {
      font-size: 0.9em;
      color: #999;
    }

    .flight-path {
      flex: 0 0 150px;
      text-align: center;
      color: #999;
    }

    .path-duration {
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .path-line {
      height: 2px;
      background: #e0e0e0;
      position: relative;
      margin: 10px 0;
    }

    .path-line::after {
      content: '→';
      position: absolute;
      right: -10px;
      top: -12px;
      font-size: 1.5em;
      color: #667eea;
    }

    .flight-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 2px solid #f0f0f0;
    }

    .flight-details {
      display: flex;
      gap: 30px;
      color: #666;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-book {
      padding: 12px 35px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-book:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #999;
    }

    .empty-icon {
      font-size: 5em;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-text {
      font-size: 1.3em;
      color: #666;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* 模态框样式 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 30px;
      border-radius: 20px 20px 0 0;
    }

    .modal-header h2 {
      font-size: 1.8em;
    }

    .modal-body {
      padding: 30px;
    }

    .booking-section {
      margin-bottom: 30px;
    }

    .booking-section h3 {
      font-size: 1.3em;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .seat-map {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .seat-row {
      display: flex;
      gap: 10px;
    }

    .seat {
      width: 45px;
      height: 45px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .seat.available {
      background: #e8f5e9;
      border-color: #4caf50;
      color: #2e7d32;
    }

    .seat.available:hover {
      background: #4caf50;
      color: white;
      transform: scale(1.1);
    }

    .seat.selected {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .seat.occupied {
      background: #ffebee;
      border-color: #f44336;
      color: #c62828;
      cursor: not-allowed;
    }

    .seat-aisle {
      width: 30px;
    }

    .passenger-forms {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .passenger-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
    }

    .passenger-form h4 {
      color: #667eea;
      margin-bottom: 15px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .order-summary {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .summary-row:last-child {
      border-bottom: none;
      font-size: 1.2em;
      font-weight: 700;
      color: #e74c3c;
    }

    .modal-footer {
      padding: 20px 30px;
      border-top: 2px solid #f0f0f0;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }

    .btn-cancel {
      padding: 12px 30px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-submit {
      padding: 12px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .search-form {
        grid-template-columns: 1fr;
      }

      .flight-route {
        flex-direction: column;
        gap: 20px;
      }

      .flight-path {
        transform: rotate(90deg);
      }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- 头部 -->
  <div class="header">
    <h1>✈️ 芜湖起飞</h1>
    <p>机票预订系统 - 瘦客户端版本</p>
  </div>

  <!-- 主内容 -->
  <div class="content">
    <!-- 搜索区域 -->
    <div class="search-section">
      <div class="search-title">查询航班</div>
      <form id="searchForm" class="search-form">
        <div class="form-group">
          <label>出发机场</label>
          <select id="departAirport" required>
            <option value="">请选择</option>
          </select>
        </div>

        <div class="form-group">
          <label>到达机场</label>
          <select id="arrivalAirport" required>
            <option value="">请选择</option>
          </select>
        </div>

        <div class="form-group">
          <label>出行日期</label>
          <input type="date" id="flightDate" required>
        </div>

        <div class="form-group">
          <label>乘客人数</label>
          <input type="number" id="passengerCount" min="1" max="9" value="1" required>
        </div>

        <button type="submit" class="btn-search" id="searchButton">
          搜索航班
        </button>
      </form>
    </div>

    <!-- 排序按钮 -->
    <div id="sortButtons" class="sort-buttons" style="display: none;">
      <button type="button" class="sort-btn active" data-sort="">默认排序</button>
      <button type="button" class="sort-btn" data-sort="PRICE">价格最低</button>
      <button type="button" class="sort-btn" data-sort="TIME">时间最短</button>
    </div>

    <!-- 结果区域 -->
    <div id="flightResults" class="results-section"></div>
  </div>
</div>

<!-- 预订模态框 -->
<div id="bookingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>确认订单</h2>
    </div>
    <div class="modal-body">
      <!-- 航班信息 -->
      <div class="booking-section">
        <h3>航班信息</h3>
        <div id="selectedFlightInfo"></div>
      </div>

      <!-- 座位选择 -->
      <div class="booking-section">
        <h3>选择座位 (<span id="selectedCount">0</span> / <span id="totalCount">0</span>)</h3>
        <div id="seatMap" class="seat-map"></div>
      </div>

      <!-- 乘客信息 -->
      <div class="booking-section">
        <h3>乘客信息</h3>
        <div id="passengerForms" class="passenger-forms"></div>
      </div>

      <!-- 订单汇总 -->
      <div class="booking-section">
        <h3>订单汇总</h3>
        <div class="order-summary" id="orderSummary"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeBookingModal()">取消</button>
      <button class="btn-submit" id="submitBooking">确认预订</button>
    </div>
  </div>
</div>
<script>
  // ==================== 配置和数据 ====================

  const API_BASE_URL = 'http://localhost:8080/api';

  // 机场数据
  const AIRPORTS = [
    { code: 'PEK', name: '北京首都国际机场', city: '北京' },
    { code: 'PVG', name: '上海浦东国际机场', city: '上海' },
    { code: 'SHA', name: '上海虹桥国际机场', city: '上海' },
    { code: 'CAN', name: '广州白云国际机场', city: '广州' },
    { code: 'SZX', name: '深圳宝安国际机场', city: '深圳' },
    { code: 'CTU', name: '成都双流国际机场', city: '成都' },
    { code: 'HGH', name: '杭州萧山国际机场', city: '杭州' },
    { code: 'WUH', name: '武汉天河国际机场', city: '武汉' },
    { code: 'XIY', name: '西安咸阳国际机场', city: '西安' },
    { code: 'CKG', name: '重庆江北国际机场', city: '重庆' },
    { code: 'KMG', name: '昆明长水国际机场', city: '昆明' },
    { code: 'NKG', name: '南京禄口国际机场', city: '南京' }
  ];

  // 全局变量
  let currentSearchParams = null;
  let currentFlights = [];
  let selectedFlight = null;
  let selectedSeats = [];
  let seatMapData = null;

  // ==================== 工具函数 ====================

  function getCityName(code) {
    const airport = AIRPORTS.find(a => a.code === code);
    return airport ? airport.city : code;
  }

  function getAirportName(code) {
    const airport = AIRPORTS.find(a => a.code === code);
    return airport ? airport.name : code;
  }

  function formatTime(datetime) {
    if (!datetime) return '';
    const date = new Date(datetime);
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  function formatDateTime(datetime) {
    if (!datetime) return '';
    const date = new Date(datetime);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}`;
  }

  function formatDuration(minutes) {
    if (!minutes) return '';
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    if (hours === 0) return `${mins}分钟`;
    if (mins === 0) return `${hours}小时`;
    return `${hours}小时${mins}分`;
  }

  function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  function showMessage(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    alert(message);
  }

  function setButtonLoading(button, loading) {
    if (loading) {
      button.disabled = true;
      button.dataset.originalText = button.innerHTML;
      button.innerHTML = '<span class="loading-spinner"></span>加载中...';
    } else {
      button.disabled = false;
      button.innerHTML = button.dataset.originalText || '搜索航班';
    }
  }

  // ==================== API 请求 ====================

  async function apiRequest(url, options = {}) {
    const defaultOptions = {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    };

    const finalOptions = { ...defaultOptions, ...options };

    try {
      console.log('请求:', API_BASE_URL + url, finalOptions);

      const response = await fetch(API_BASE_URL + url, finalOptions);

      console.log('响应状态:', response.status);

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
      }

      const data = await response.json();
      console.log('响应数据:', data);

      return data;
    } catch (error) {
      console.error('API 请求失败:', error);
      throw error;
    }
  }

  async function searchFlights(params) {
    return await apiRequest('/flights/search', {
      method: 'POST',
      body: JSON.stringify(params)
    });
  }

  async function getSeatMap(instanceId) {
    return await apiRequest(`/bookings/seat-map/${instanceId}`);
  }

  async function createBooking(bookingData) {
    return await apiRequest('/bookings', {
      method: 'POST',
      body: JSON.stringify(bookingData)
    });
  }

  // ==================== 页面初始化 ====================

  function initPage() {
    console.log('初始化页面...');

    populateAirportSelectors();
    setDefaultDate();
    bindEvents();

    console.log('页面初始化完成');
  }

  function populateAirportSelectors() {
    const departSelect = document.getElementById('departAirport');
    const arrivalSelect = document.getElementById('arrivalAirport');

    if (!departSelect || !arrivalSelect) {
      console.error('未找到机场选择器');
      return;
    }

    departSelect.innerHTML = '<option value="">请选择</option>';
    arrivalSelect.innerHTML = '<option value="">请选择</option>';

    AIRPORTS.forEach(airport => {
      const option1 = document.createElement('option');
      option1.value = airport.code;
      option1.textContent = `${airport.city} - ${airport.name}`;
      departSelect.appendChild(option1);

      const option2 = document.createElement('option');
      option2.value = airport.code;
      option2.textContent = `${airport.city} - ${airport.name}`;
      arrivalSelect.appendChild(option2);
    });

    console.log('机场选择器填充完成');
  }

  function setDefaultDate() {
    const dateInput = document.getElementById('flightDate');
    if (!dateInput) return;

    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);

    const year = tomorrow.getFullYear();
    const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
    const day = String(tomorrow.getDate()).padStart(2, '0');

    dateInput.value = `${year}-${month}-${day}`;
    dateInput.min = `${year}-${month}-${day}`;
  }

  function bindEvents() {
    // 搜索表单
    const searchForm = document.getElementById('searchForm');
    if (searchForm) {
      searchForm.addEventListener('submit', handleSearch);
    }

    // 排序按钮
    const sortButtons = document.querySelectorAll('.sort-btn');
    sortButtons.forEach(btn => {
      btn.addEventListener('click', () => handleSort(btn));
    });

    // 提交订单按钮
    const submitBtn = document.getElementById('submitBooking');
    if (submitBtn) {
      submitBtn.addEventListener('click', handleSubmitBooking);
    }

    console.log('事件绑定完成');
  }

  // ==================== 航班搜索 ====================

  async function handleSearch(event) {
    event.preventDefault();

    console.log('开始搜索航班');

    const submitBtn = document.getElementById('searchButton');

    const departAirport = document.getElementById('departAirport').value;
    const arrivalAirport = document.getElementById('arrivalAirport').value;
    const flightDate = document.getElementById('flightDate').value;
    const passengerCount = parseInt(document.getElementById('passengerCount').value);

    if (!departAirport || !arrivalAirport) {
      showMessage('请选择出发和到达机场', 'warning');
      return;
    }

    if (departAirport === arrivalAirport) {
      showMessage('出发机场和到达机场不能相同', 'warning');
      return;
    }

    if (!flightDate) {
      showMessage('请选择出行日期', 'warning');
      return;
    }

    if (!passengerCount || passengerCount < 1 || passengerCount > 9) {
      showMessage('乘客人数必须在 1-9 之间', 'warning');
      return;
    }

    const params = {
      departCity: departAirport,
      arrivalCity: arrivalAirport,
      flightDate: flightDate,
      passengerCount: passengerCount,
      sortType: null
    };

    console.log('查询参数:', params);

    currentSearchParams = params;

    setButtonLoading(submitBtn, true);

    try {
      const flights = await searchFlights(params);

      currentFlights = flights;
      displayFlights(flights);

      const sortButtonsContainer = document.getElementById('sortButtons');
      if (sortButtonsContainer) {
        sortButtonsContainer.style.display = flights.length > 0 ? 'flex' : 'none';
      }

      if (flights.length === 0) {
        showMessage('未查询到符合条件的航班', 'info');
      } else {
        showMessage(`查询到 ${flights.length} 个航班`, 'success');
      }

    } catch (error) {
      console.error('查询失败:', error);
      showMessage('查询失败: ' + error.message, 'error');

      document.getElementById('flightResults').innerHTML = '';

    } finally {
      setButtonLoading(submitBtn, false);
    }
  }

  async function handleSort(button) {
    const sortType = button.dataset.sort;
    console.log('切换排序:', sortType || '默认');

    const allButtons = document.querySelectorAll('.sort-btn');
    allButtons.forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');

    if (currentSearchParams) {
      currentSearchParams.sortType = sortType || null;

      try {
        const flights = await searchFlights(currentSearchParams);
        currentFlights = flights;
        displayFlights(flights);

        const sortName = sortType === 'PRICE' ? '价格' :
                sortType === 'TIME' ? '时间' : '默认';
        showMessage(`已按${sortName}排序`, 'success');
      } catch (error) {
        showMessage('排序失败: ' + error.message, 'error');
      }
    }
  }

  function displayFlights(flights) {
    const container = document.getElementById('flightResults');

    if (!container) {
      console.error('未找到结果容器');
      return;
    }

    container.innerHTML = '';

    if (flights.length === 0) {
      container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">✈️</div>
                        <div class="empty-text">未查询到符合条件的航班</div>
                    </div>
                `;
      return;
    }

    flights.forEach(flight => {
      const card = createFlightCard(flight);
      container.appendChild(card);
    });

    console.log('显示', flights.length, '个航班');
  }

  function createFlightCard(flight) {
    const card = document.createElement('div');
    card.className = 'flight-card';

    const departTime = formatTime(flight.departDatetime);
    const arrivalTime = formatTime(flight.arrivalDatetime);
    const duration = formatDuration(flight.flightDurationMin);

    card.innerHTML = `
                <div class="flight-header">
                    <div>
                        <span class="flight-number">${flight.flightNumber}</span>
                        <span class="airline-name">${flight.airlineName}</span>
                    </div>
                    <div class="flight-price">¥${flight.price}</div>
                </div>

                <div class="flight-route">
                    <div class="airport-info">
                        <div class="airport-time">${departTime}</div>
                        <div class="airport-code">${flight.departAirport}</div>
                        <div class="airport-name">${getCityName(flight.departAirport)}</div>
                    </div>

                    <div class="flight-path">
                        <div class="path-duration">${duration}</div>
                        <div class="path-line"></div>
                        <div>直飞</div>
                    </div>

                    <div class="airport-info">
                        <div class="airport-time">${arrivalTime}</div>
                        <div class="airport-code">${flight.arrivalAirport}</div>
                        <div class="airport-name">${getCityName(flight.arrivalAirport)}</div>
                    </div>
                </div>

                <div class="flight-footer">
                    <div class="flight-details">
                        <div class="detail-item">
                            <span>机型: ${flight.aircraftName || flight.aircraftCode}</span>
                        </div>
                        <div class="detail-item">
                            <span>剩余: ${flight.availableSeats} 座</span>
                        </div>
                    </div>
                    <button class="btn-book" onclick="openBookingModal('${flight.instanceId}')">
                        立即预订
                    </button>
                </div>
            `;

    return card;
  }

  // ==================== 预订流程 ====================

  async function openBookingModal(instanceId) {
    console.log('打开预订模态框:', instanceId);

    selectedFlight = currentFlights.find(f => f.instanceId === instanceId);

    if (!selectedFlight) {
      showMessage('未找到航班信息', 'error');
      return;
    }

    selectedSeats = [];

    // 显示模态框
    const modal = document.getElementById('bookingModal');
    modal.classList.add('active');

    // 显示航班信息
    displaySelectedFlightInfo();

    // 加载座位图
    await loadSeatMap(instanceId);

    // 生成乘客表单
    generatePassengerForms();

    // 更新订单汇总
    updateOrderSummary();
  }

  function closeBookingModal() {
    const modal = document.getElementById('bookingModal');
    modal.classList.remove('active');

    selectedFlight = null;
    selectedSeats = [];
    seatMapData = null;
  }

  function displaySelectedFlightInfo() {
    const container = document.getElementById('selectedFlightInfo');

    if (!container || !selectedFlight) return;

    container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 15px; background: white; border-radius: 10px;">
                    <div><strong>航班号:</strong> ${selectedFlight.flightNumber}</div>
                    <div><strong>航司:</strong> ${selectedFlight.airlineName}</div>
                    <div><strong>出发:</strong> ${getCityName(selectedFlight.departAirport)} ${formatTime(selectedFlight.departDatetime)}</div>
                    <div><strong>到达:</strong> ${getCityName(selectedFlight.arrivalAirport)} ${formatTime(selectedFlight.arrivalDatetime)}</div>
                    <div><strong>价格:</strong> <span style="color: #e74c3c; font-weight: bold;">¥${selectedFlight.price}</span></div>
                </div>
            `;
  }

  async function loadSeatMap(instanceId) {
    try {
      console.log('加载座位图:', instanceId);

      seatMapData = await getSeatMap(instanceId);

      renderSeatMap();

    } catch (error) {
      console.error('加载座位图失败:', error);
      showMessage('加载座位图失败: ' + error.message, 'error');
    }
  }

  function renderSeatMap() {
    const container = document.getElementById('seatMap');

    if (!container || !seatMapData || !seatMapData.seats) {
      console.error('座位数据无效');
      return;
    }

    const passengerCount = currentSearchParams ? currentSearchParams.passengerCount : 1;
    document.getElementById('totalCount').textContent = passengerCount;
    document.getElementById('selectedCount').textContent = selectedSeats.length;

    const seats = seatMapData.seats;
    const rowCount = Math.max(...seats.map(s => s.rowNumber));

    // 按行分组
    const seatsByRow = {};
    seats.forEach(seat => {
      if (!seatsByRow[seat.rowNumber]) {
        seatsByRow[seat.rowNumber] = [];
      }
      seatsByRow[seat.rowNumber].push(seat);
    });

    container.innerHTML = '';

    // 渲染座位
    for (let row = 1; row <= rowCount; row++) {
      const rowSeats = seatsByRow[row] || [];
      const rowDiv = document.createElement('div');
      rowDiv.className = 'seat-row';

      // 左侧座位 (A, B, C)
      ['A', 'B', 'C'].forEach(letter => {
        const seat = rowSeats.find(s => s.seatLetter === letter);
        if (seat) {
          rowDiv.appendChild(createSeatElement(seat));
        }
      });

      // 过道
      const aisle = document.createElement('div');
      aisle.className = 'seat-aisle';
      rowDiv.appendChild(aisle);

      // 右侧座位 (D, E, F)
      ['D', 'E', 'F'].forEach(letter => {
        const seat = rowSeats.find(s => s.seatLetter === letter);
        if (seat) {
          rowDiv.appendChild(createSeatElement(seat));
        }
      });

      container.appendChild(rowDiv);
    }
  }

  function createSeatElement(seat) {
    const seatDiv = document.createElement('div');
    seatDiv.className = 'seat';
    seatDiv.textContent = seat.seatNumber;

    const isSelected = selectedSeats.includes(seat.seatNumber);

    if (seat.status === 'AVAILABLE') {
      seatDiv.classList.add(isSelected ? 'selected' : 'available');
      seatDiv.onclick = () => toggleSeat(seat.seatNumber);
    } else {
      seatDiv.classList.add('occupied');
    }

    return seatDiv;
  }

  function toggleSeat(seatNumber) {
    const passengerCount = currentSearchParams ? currentSearchParams.passengerCount : 1;

    const index = selectedSeats.indexOf(seatNumber);

    if (index > -1) {
      selectedSeats.splice(index, 1);
    } else {
      if (selectedSeats.length >= passengerCount) {
        showMessage(`最多只能选择 ${passengerCount} 个座位`, 'warning');
        return;
      }
      selectedSeats.push(seatNumber);
    }

    renderSeatMap();
    updateOrderSummary();
  }

  function generatePassengerForms() {
    const container = document.getElementById('passengerForms');

    if (!container) return;

    const passengerCount = currentSearchParams ? currentSearchParams.passengerCount : 1;

    container.innerHTML = '';

    for (let i = 0; i < passengerCount; i++) {
      const formDiv = document.createElement('div');
      formDiv.className = 'passenger-form';

      formDiv.innerHTML = `
                    <h4>乘客 ${i + 1} ${i === 0 ? '（联系人）' : ''}</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>姓名 *</label>
                            <input type="text" id="name_${i}" required>
                        </div>
                        <div class="form-group">
                            <label>证件类型 *</label>
                            <select id="idType_${i}" required>
                                <option value="ID_CARD">身份证</option>
                                <option value="PASSPORT">护照</option>
                                <option value="OTHER">其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>证件号 *</label>
                            <input type="text" id="idNumber_${i}" required>
                        </div>
                        <div class="form-group">
                            <label>手机号 *</label>
                            <input type="tel" id="phone_${i}" required pattern="^1[3-9]\\d{9}$">
                        </div>
                        <div class="form-group">
                            <label>邮箱</label>
                            <input type="email" id="email_${i}">
                        </div>
                        <div class="form-group">
                            <label>乘客类型 *</label>
                            <select id="passengerType_${i}" required>
                                <option value="ADULT">成人</option>
                                <option value="CHILD">儿童</option>
                                <option value="INFANT">婴儿</option>
                            </select>
                        </div>
                    </div>
                `;

      container.appendChild(formDiv);
    }
  }

  function updateOrderSummary() {
    const container = document.getElementById('orderSummary');

    if (!container || !selectedFlight) return;

    const passengerCount = currentSearchParams ? currentSearchParams.passengerCount : 1;
    const totalPrice = selectedFlight.price * passengerCount;

    container.innerHTML = `
                <div class="summary-row">
                    <span>航班:</span>
                    <span>${selectedFlight.flightNumber}</span>
                </div>
                <div class="summary-row">
                    <span>乘客人数:</span>
                    <span>${passengerCount}</span>
                </div>
                <div class="summary-row">
                    <span>单价:</span>
                    <span>¥${selectedFlight.price}</span>
                </div>
                <div class="summary-row">
                    <span>已选座位:</span>
                    <span>${selectedSeats.join(', ') || '未选择'}</span>
                </div>
                <div class="summary-row">
                    <span>总价:</span>
                    <span>¥${totalPrice}</span>
                </div>
            `;
  }

  async function handleSubmitBooking() {
    console.log('提交订单');

    const passengerCount = currentSearchParams ? currentSearchParams.passengerCount : 1;

    // 校验座位
    if (selectedSeats.length !== passengerCount) {
      showMessage(`请选择 ${passengerCount} 个座位（当前已选 ${selectedSeats.length} 个）`, 'warning');
      return;
    }

    // 收集乘客信息
    const passengers = [];
    for (let i = 0; i < passengerCount; i++) {
      const name = document.getElementById(`name_${i}`).value.trim();
      const idType = document.getElementById(`idType_${i}`).value;
      const idNumber = document.getElementById(`idNumber_${i}`).value.trim();
      const phone = document.getElementById(`phone_${i}`).value.trim();
      const email = document.getElementById(`email_${i}`).value.trim();
      const passengerType = document.getElementById(`passengerType_${i}`).value;

      if (!name || !idNumber || !phone) {
        showMessage(`请完整填写乘客 ${i + 1} 的信息`, 'warning');
        return;
      }

      passengers.push({
        passengerName: name,
        idType: idType,
        idNumber: idNumber,
        phone: phone,
        email: email || null,
        passengerType: passengerType,
        seatPreference: 'ANY'
      });
    }

    // 构建订单数据
    const bookingData = {
      instanceId: selectedFlight.instanceId,
      passengers: passengers,
      seatNumbers: selectedSeats,
      contactPassengerIndex: 0,
      clientToken: generateUUID(),
      remark: '瘦客户端预订'
    };

    console.log('订单数据:', bookingData);

    const submitBtn = document.getElementById('submitBooking');
    setButtonLoading(submitBtn, true);

    try {
      const response = await createBooking(bookingData);

      console.log('订单创建成功:', response);

      showMessage('订单创建成功！订单号: ' + response.bookingId, 'success');

      // 关闭模态框
      closeBookingModal();

      // 可选：跳转到订单详情页
      // window.location.href = 'orders.html';

    } catch (error) {
      console.error('订单创建失败:', error);
      showMessage('订单创建失败: ' + error.message, 'error');

    } finally {
      setButtonLoading(submitBtn, false);
    }
  }

  // ==================== 页面加载 ====================

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPage);
  } else {
    initPage();
  }

  console.log('脚本加载完成');
</script>
</body>
</html>

