<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.luzai.aircraftserver.mapper.BookingMapper">

    <!-- 插入订单 -->
    <insert id="insert">
        INSERT INTO booking (
            booking_id,
            booking_type,
            passenger_count,
            contact_passenger_id,
            total_original_price,
            discount_amount,
            total_price,
            currency,
            status,
            hold_expire_at,
            booking_time,
            client_token,
            remark
        ) VALUES (
                     #{bookingId},
                     #{bookingType},
                     #{passengerCount},
                     #{contactPassengerId},
                     #{totalOriginalPrice},
                     #{discountAmount},
                     #{totalPrice},
                     #{currency},
                     #{status},
                     #{holdExpireAt},
                     #{bookingTime},
                     #{clientToken},
                     #{remark}
                 )
    </insert>

    <!-- 根据订单号查询 -->
    <select id="findByBookingId" resultType="cn.luzai.aircraftpojo.entity.core.Booking">
        SELECT
            booking_id AS bookingId,
            booking_type AS bookingType,
            passenger_count AS passengerCount,
            contact_passenger_id AS contactPassengerId,
            total_original_price AS totalOriginalPrice,
            discount_amount AS discountAmount,
            total_price AS totalPrice,
            currency,
            status,
            hold_expire_at AS holdExpireAt,
            booking_time AS bookingTime,
            payment_time AS paymentTime,
            cancel_time AS cancelTime,
            client_token AS clientToken,
            remark
        FROM booking
        WHERE booking_id = #{bookingId}
    </select>

    <!-- 根据客户端Token查询（幂等性） -->
    <select id="findByClientToken" resultType="cn.luzai.aircraftpojo.entity.core.Booking">
        SELECT
            booking_id AS bookingId,
            booking_type AS bookingType,
            passenger_count AS passengerCount,
            contact_passenger_id AS contactPassengerId,
            total_original_price AS totalOriginalPrice,
            discount_amount AS discountAmount,
            total_price AS totalPrice,
            currency,
            status,
            hold_expire_at AS holdExpireAt,
            booking_time AS bookingTime,
            payment_time AS paymentTime,
            cancel_time AS cancelTime,
            client_token AS clientToken,
            remark
        FROM booking
        WHERE client_token = #{clientToken}
    </select>

    <!-- 更新订单状态 -->
    <update id="updateStatus">
        UPDATE booking
        SET status = #{newStatus}
#             update_time = NOW()
        WHERE booking_id = #{bookingId}
          AND status = #{oldStatus}
    </update>

    <!-- 查询用户的订单列表 -->
    <select id="findUserBookings" resultType="cn.luzai.aircraftpojo.dto.response.BookingListResponse">
        SELECT
        b.booking_id AS bookingId,
        b.status,
        bs.flight_number AS flightNumber,
        bs.airline_code,
        bs.depart_airport AS departAirport,
        bs.arrival_airport AS arrivalAirport,
        bs.depart_datetime AS departDatetime,
        bs.arrival_datetime AS arrivalDatetime,
        b.total_price AS totalPrice,
        b.booking_time AS bookingTime,
        CASE
        WHEN b.status IN ('HOLD', 'CONFIRMED') AND bs.depart_datetime > NOW() THEN TRUE
        ELSE FALSE
        END AS cancellable
        FROM booking b
        INNER JOIN booking_segment bs ON b.booking_id = bs.booking_id
        WHERE b.contact_passenger_id IN (
        SELECT passenger_id
        FROM passenger
        WHERE 1=1
        <if test="phone != null and phone != ''">
            AND phone = #{phone}
        </if>
        <if test="idNumber != null and idNumber != ''">
            AND id_number = #{idNumber}
        </if>
        )
        <if test="status != null and status != ''">
            AND b.status = #{status}
        </if>
        AND b.booking_time >= #{startTime}
        ORDER BY b.booking_time DESC
    </select>

    <!-- 取消订单 -->
    <update id="cancelBooking">
        UPDATE booking
        SET status = 'CANCELLED',
            cancel_time = #{cancelTime},
            remark = CONCAT(IFNULL(remark, ''), ' [取消原因: ', #{cancelReason}, ']')
        WHERE booking_id = #{bookingId}
          AND status IN ('HOLD', 'CONFIRMED')
    </update>

</mapper>